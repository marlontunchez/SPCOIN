@using System.Text.Json
@model List<Reparacion>



@{
    ViewData["Title"] = "Reparaciones";
}

<h1>Reparaciones Activas</h1>
<br>
@*<a href="@Url.Action("Create", "Reparacion")" class="btn btn-primary mb-3">Crear nueva reparación</a>*@
@*<a id="idCreaReparacion" class="btn btn-primary mb-3">Crear nueva reparación</a>*@
<button type="button" class="btn btn-primary" onclick="mostrarModal()">Crear Reparacion</button>
<br><br>

@if (Model == null || !Model.Any())
{
    <div>No se encontraron reparaciones</div>
}
else
{
  
    <div class="table-responsive" >
 <table class="striped" >

        <thead class="thead-dark">
            <tr>
                <th>Código</th>
                <th>Fecha</th>
                <th>NIT</th>
                <th>Nombre</th>
                <th>Motocicleta</th>
                <th>Mecánico</th>
                <th>Convertido</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var reparacion in Model)
            {
                <tr>
                    <td>@reparacion.CodigoReparacion</td>
                    <td>@reparacion.Fecha.ToShortDateString()</td>
                    <td>@reparacion.Nit</td>
                    <td>@reparacion.Nombre</td>
                    <td>@reparacion.Motocicleta</td>
                    <td>@reparacion.Mecanico</td>
                    <td>@(reparacion.ConvertidoAVenta ? "Sí" : "No")</td>
                    <td>
                   
                        <button type="button" class="btn btn-danger btn-lg eliminarBtn" data-codigo-reparacion="@reparacion.CodigoReparacion" title="Eliminar reparación"></button>
<button type="button" class="btn btn-primary btn-lg detalle-btn" data-codigo-reparacion="@reparacion.CodigoReparacion" id="detalle-btn-@reparacion.CodigoReparacion" title="Ver detalle"></button>
        

                        <button type="button" class="btn btn-success btn-lg convertirBtn" data-codigo-reparacion="@reparacion.CodigoReparacion" title="Convertir reparación"></button>
                   </td>
                </tr>
            }
            @if (!Model.Any())
            {
                <tr>
                    <td colspan="8">No se encontraron reparaciones</td>
                </tr>
            }
        </tbody>
    </table>
</div>



}

<div class="modal fade" id="Create" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Crear Reparación</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="cerrarModal()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form id="reparacion-form">
        <div class="modal-body">
          <div class="form-group">
            <label for="motocicleta">Motocicleta</label>
            <input type="text" class="form-control" id="motocicleta" name="motocicleta" required>
          </div>
          <div class="form-group">
            <label for="mecanico">Mecánico</label>
            <input type="text" class="form-control" id="mecanico" name="mecanico" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="cerrarModal()">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="guardarReparacion()">Aceptar</button>
        </div>
      </form>
    </div>
  </div>
</div>


<div class="modal fade" id="eliminarModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Confirmación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        ¿Estás seguro que deseas eliminar la reparación?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="confirmarEliminarBtn" data-dismiss="modal">Eliminar</button>
        <input type="hidden" id="codigoReparacionEliminar">
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="convertirModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Confirmación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        ¿Estás seguro que deseas convertir la reparación en venta?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="confirmarConvertirBtn" data-dismiss="modal">Convertir</button>
        <input type="hidden" id="codigoReparacionConvertir">
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="detalle-modal" tabindex="-1" aria-labelledby="detalle-modal-label" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detalle-modal-label">Detalle de reparación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form class="row g-3 mb-3">
          <div class="col-md-2">
            <label for="input-codigo-producto" class="form-label">Código producto</label>
            <input type="text" class="form-control" id="input-codigo-producto">
          </div>
          <div class="col-md-3">
            <label for="input-nombre-producto" class="form-label">Nombre producto</label>
            <input type="text" class="form-control" id="input-nombre-producto">
          </div>
          <div class="col-md-2">
            <label for="input-unidades" class="form-label">Unidades</label>
            <input type="number" class="form-control" id="input-unidades">
          </div>
          <div class="col-md-2">
            <label for="input-precio" class="form-label">Precio</label>
            <input type="number" class="form-control" id="input-precio" step="0.01">
          </div>
          <div class="col-md-2">
            <label for="input-total" class="form-label">Total</label>
            <input type="number" class="form-control" id="input-total" step="0.01" readonly>
          </div>
          <div class="col-md-1">
            <label for="btn-agregar">&nbsp;</label>
            <button type="button" class="btn btn-primary form-control" id="btn-agregar">Agregar</button>
          </div>
        </form>
        <table class="table">
          <thead>
            <tr>
              <th>Código</th>
              <th>Código Producto</th>
              <th>Nombre</th>
              <th>Unidades</th>
              <th>Precio</th>
              <th>Total</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="detalle-table-body">
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


<script>
function mostrarModal() {
  $('#Create').modal('show');

}

function convertirReparacion() {
  var codigoReparacion = $('#codigoReparacionConvertir').val();
  console.log('Código de reparación a convertir: ' + codigoReparacion);
  $.ajax({
    type: 'POST',
    url: '/reparacion/convertir',
    data: { codigoReparacion: codigoReparacion },
    success: function(response) {
      console.log(response);
      if (response.success) {
        alert('La reparación se ha convertido en orden de trabajo correctamente.');
        window.location.reload();
      } else {
        alert('No se ha podido convertir la reparación en orden de trabajo.');
      }
    },
    error: function(xhr, status, error) {
      console.log(xhr.responseText);
      alert('Ha ocurrido un error al intentar convertir la reparación en orden de trabajo.');
    }
  });
}


function cerrarModal() {
  $('#Create').modal('hide');
}
function cerrarDetalle() {
  $('#Detalle').modal('hide');
}

function guardarReparacion() {
  var formData = {
    'motocicleta': $('#motocicleta').val(),
    'mecanico': $('#mecanico').val()
  };
  
  $.ajax({
    type: 'POST',
    url: '@Url.Action("Create", "Reparacion")',
    data: formData,
    success: function(data) {
      // Cierra el modal después de enviar la petición
      $('#Create').modal('hide');
      // Recarga la página después de cerrar el modal
      location.reload();
    },
    error: function(xhr, status, error) {
      // En caso de error, muestra el mensaje de error en la consola.
      console.error(error);
    }
  });
}


$(document).ready(function() {
  $('.eliminarBtn').click(function() {
    var codigoReparacion = $(this).data('codigo-reparacion');
    console.log(codigoReparacion); // Agregamos el console.log para mostrar el valor de codigoreparacion
    $('#eliminarModal').modal('show');
    $('#codigoReparacionEliminar').val(codigoReparacion);
  });
});

$(document).ready(function() {
  $('#confirmarEliminarBtn').click(function() {
    var codigoReparacion = $('#codigoReparacionEliminar').val();
    console.log('Código de reparación a eliminar: ' + codigoReparacion); // Muestra el código de reparación en la consola
    $.ajax({
      type: 'DELETE',
      url: '@Url.Action("Delete", "Reparacion")',
      data: {codigoReparacion: codigoReparacion},
      success: function(data) {
        console.log('Reparación eliminada correctamente'); // Muestra un mensaje de éxito en la consola
        // Cierra el modal después de enviar la petición
        $('#eliminarModal').modal('hide');
        // Recarga la página después de cerrar el modal
        location.reload();
      },
      error: function(xhr, status, error) {
        // En caso de error, muestra el mensaje de error en la consola.
        console.error(error);
      }
    });
  });
});

$(document).ready(function() {
  $('.eliminarBtn').click(function() {
    var codigoReparacion = $(this).data('codigo-reparacion');
    console.log(codigoReparacion); // Agregamos el console.log para mostrar el valor de codigoreparacion
    $('#eliminarModal').modal('show');
    $('#codigoReparacionEliminar').val(codigoReparacion);
  });


  $('#confirmarEliminarBtn').click(function() {
    var codigoReparacion = $('#codigoReparacionEliminar').val();
    console.log('Código de reparación a eliminar: ' + codigoReparacion); // Muestra el código de reparación en la consola
    $.ajax({
      type: 'DELETE',
      url: '@Url.Action("Delete", "Reparacion")',
      data: {codigoReparacion: codigoReparacion},
      success: function(data) {
        console.log('Reparación eliminada correctamente'); // Muestra un mensaje de éxito en la consola
        // Cierra el modal después de enviar la petición
        $('#eliminarModal').modal('hide');
        // Recarga la página después de cerrar el modal
        location.reload();
      },
      error: function(xhr, status, error) {
        // En caso de error, muestra el mensaje de error en la consola.
        console.error(error);
      }
    });
  });

    $('.convertirBtn').click(function() {
    var codigoReparacion = $(this).data('codigo-reparacion');
    console.log(codigoReparacion);
    $('#convertirModal').modal('show');
    $('#codigoReparacionConvertir').val(codigoReparacion);
  });


  $('#confirmarConvertirBtn').click(function() {
    var codigoReparacion = $('#codigoReparacionConvertir').val();
    console.log('Código de reparación a convertir: ' + codigoReparacion);
    $.ajax({
      type: 'POST',
      url: '@Url.Action("Convertir", "Reparacion")',
      data: {codigoReparacion: codigoReparacion},
      success: function(data) {
        console.log('Reparación convertida correctamente');
        $('#convertirModal').modal('hide');
        location.reload();
      },
      error: function(xhr, status, error) {
        console.error(error);
      }
    });
  });
});




$('.detalle-btn').click(function() {
  var codigoReparacion = $(this).data('codigo-reparacion');
  console.log('Código de reparación:', codigoReparacion);
  $('#detalle-modal').modal('show');
  $('#detalle-modal').find('#codigoReparacion').val(codigoReparacion);
  llamardetalle(codigoReparacion);
});



function llamardetalle(codigoReparacion) {
  console.log('Código de reparación:', codigoReparacion); // Agrega esta línea para verificar que el código de reparación se está enviando correctamente
  console.log('Iniciando llamada AJAX para obtener detalle de reparación');
  $.ajax({
    url: '@Url.Action("Detalle", "Reparacion")',
    data: { codigoReparacion: codigoReparacion },
    type: 'GET',
    dataType: 'JSON',
    success: function(response) {
      console.log('Respuesta recibida:');
      console.log(response);
      if (response.status == true) {
        var datos = response.data;
        console.log('Datos recibidos:');
        console.log(datos);
        llenarTablaDetalle(datos);
      } else {
        console.log('Error en la respuesta:');
        console.log(response);
        alert(response.message);
      }
    },
    error: function(jqXHR, textStatus, errorThrown) {
      console.log('Error en la llamada AJAX:');
      console.log(textStatus, errorThrown);
    }
  });
}

function llenarTablaDetalle(datos) {
  console.log('Llenando tabla con datos:', datos);
  var tablaDetalle = $('#detalle-table-body');
  tablaDetalle.empty();
  $.each(datos, function(index, row) {
    var fila = '<tr>' +
                 '<td>' + row.codigoDetalleReparacion + '</td>' +
                 '<td>' + row.codigoProducto + '</td>' +
                 '<td>' + row.nombre + '</td>' +
                 '<td>' + row.unidades + '</td>' +
                 '<td>' + row.precio + '</td>' +
                 '<td>' + row.total + '</td>' +
               '<td>' + '<button class="btn btn-danger btn-eliminar-detalle" data-codigo-detalle-reparacion="' + row.codigoDetalleReparacion + '">Eliminar</button>' + '</td>' +
               '</tr>';
    tablaDetalle.append(fila);
  });
}

$(document).on('click', '.btn-eliminar-detalle', function() {
  var codigoDetalleReparacion = $(this).data('codigo-detalle-reparacion');
  console.log('Código de detalle de reparación a eliminar:', codigoDetalleReparacion);
  // Realizar aquí la llamada AJAX para eliminar el detalle de reparación correspondiente
});

;



</script>
