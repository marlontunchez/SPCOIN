@using System.Text.Json
@model List<Reparacion>



@{
    ViewData["Title"] = "Reparaciones";
}

<h1>Reparaciones Activas</h1>

@*<a href="@Url.Action("Create", "Reparacion")" class="btn btn-primary mb-3">Crear nueva reparación</a>*@
@*<a id="idCreaReparacion" class="btn btn-primary mb-3">Crear nueva reparación</a>*@
<button type="button" class="btn btn-primary" onclick="mostrarModal()">Crear Reparacion</button>

@if (Model == null || !Model.Any())
{
    <div>No se encontraron reparaciones</div>
}
else
{
    <div class="table-responsive">
        <table class="table table-bordered table-hover table-striped">
            <thead class="thead-dark">
                <tr>
                    <th>Código Reparación</th>
                    <th>Fecha</th>
                    <th>NIT</th>
                    <th>Nombre</th>
                    <th>Motocicleta</th>
                    <th>Mecánico</th>
                    <th>Convertido a venta</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var reparacion in Model)
                {
                    <tr>
                        <td>@reparacion.CodigoReparacion</td>
                        <td>@reparacion.Fecha.ToShortDateString()</td>
                        <td>@reparacion.Nit</td>
                        <td>@reparacion.Nombre</td>
                        <td>@reparacion.Motocicleta</td>
                        <td>@reparacion.Mecanico</td>
                        <td>@(reparacion.ConvertidoAVenta ? "Sí" : "No")</td>
                        <td>
                       <button type="button" class="btn btn-danger btn-lg" onclick="EliminarModal()" title="Eliminar" data-codigoreparacion="{{codigoreparacion}}"></button>
                       <button type="button" class="btn btn-primary btn-lg" onclick="mostrarDetale()" title="Ver detalle"></button>
                     <button type="button" class="btn btn-success btn-lg" id="convertirBtn" onclick="mostrarConvertir()"title="Convertir a venta">Convertir</button>

              </td>
                    </tr>
                }
                @if (!Model.Any())
                {
                    <tr>
                        <td colspan="8">No se encontraron reparaciones</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<div class="modal fade" id="Create" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Crear Reparación</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="cerrarModal()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form id="reparacion-form">
        <div class="modal-body">
          <div class="form-group">
            <label for="motocicleta">Motocicleta</label>
            <input type="text" class="form-control" id="motocicleta" name="motocicleta" required>
          </div>
          <div class="form-group">
            <label for="mecanico">Mecánico</label>
            <input type="text" class="form-control" id="mecanico" name="mecanico" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="cerrarModal()">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="guardarReparacion()">Aceptar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="Eliminar" tabindex="-1" role="dialog" aria-labelledby="confirmarEliminacionModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmarEliminacionModalLabel">Confirmar eliminación</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar" onclick="CerrarEliminar()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        ¿Estás seguro de que deseas eliminar este elemento?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="CerrarEliminar()">Cancelar</button>
<button type="button" class="btn btn-danger" onclick="EliminaModal(event)" data-codigoreparacion="{{codigoreparacion}}">Eliminar</button>

      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="Convertir" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Confirmación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        ¿Estás seguro que deseas convertir la reparación en una venta?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="confirmarBtn">Convertir</button>
      </div>
    </div>
  </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<@*div class="modal fade" id="Detalle" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLiveLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="staticBackdropLiveLabel">Detalle de reparación</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Código de detalle</th>
              <th>Código de producto</th>
              <th>Nombre</th>
              <th>Unidades</th>
              <th>Precio</th>
              <th>Total</th>
              <th>Descuento</th>
            </tr>
          </thead>
          <tbody>
            @foreach (var detalle in Model.DetallesReparacion)
            {
              <tr>
                <td>@detalle.CodigoDetalleReparacion</td>
                <td>@detalle.CodigoProducto</td>
                <td>@detalle.Nombre</td>
                <td>@detalle.Unidades</td>
                <td>@detalle.Precio</td>
                <td>@detalle.Total</td>
                <td>@detalle.Descuento</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
*@
<script>
function mostrarModal() {
  $('#Create').modal('show');

}
function mostrarDetale() {
  $('#Detalle').modal('show');
  }
  function mostrarConvertir() {
  $('#Convertir').modal('show');
  }
function cerrarModal() {
  $('#Create').modal('hide');
}
function cerrarDetalle() {
  $('#Detalle').modal('hide');
}

function guardarReparacion() {
  var formData = {
    'motocicleta': $('#motocicleta').val(),
    'mecanico': $('#mecanico').val()
  };
  
  $.ajax({
    type: 'POST',
    url: '@Url.Action("Create", "Reparacion")',
    data: formData,
    success: function(data) {
      // Cierra el modal después de enviar la petición
      $('#Create').modal('hide');
      // Recarga la página después de cerrar el modal
      location.reload();
    },
    error: function(xhr, status, error) {
      // En caso de error, muestra el mensaje de error en la consola.
      console.error(error);
    }
  });
}


$(document).ready(function() {
  $('#confirmarBtn').click(function() {
    $.ajax({
      type: 'POST',
      url: '@Url.Action("Convertir", "Reparacion")',
      success: function(data) {
        // Cierra el modal después de enviar la petición
        $('#confirmacionModal').modal('hide');
        // Recarga la página después de cerrar el modal
        location.reload();
      },
      error: function(xhr, status, error) {
        // En caso de error, muestra el mensaje de error en la consola.
        console.error(error);
      }
    });
  });
});



function EliminarModal(codigoReparacion) {
  $('#Eliminar').modal('show');
  $("#eliminarBtn").on("click", function() {
    EliminarReparacion(codigoReparacion);
  });
}

function CerrarEliminar() {
  $('#Eliminar').modal('hide');
}

function EliminaModal(btnEliminar) {
  var codigoReparacion = btnEliminar.dataset.codigoreparacion;
  // Resto del código...
  $("#eliminarBtn").on("click", function() {
    EliminarReparacion(codigoReparacion);
  });
}

function EliminarReparacion(codigoReparacion) {
  $.ajax({
    url: "reparacion/delete/" + codigoReparacion,
    type: "POST",
    data: { codigo_reparacion: codigoReparacion },
    success: function(response) {
      // Resto del código...
    },
    error: function(jqXHR, textStatus, errorThrown) {
      // Resto del código...
    }
  });
}



</script>
